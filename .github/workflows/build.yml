name: Build and Release

on:
  push:
    branches: [master]
    tags:
      - 'v*'
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout ReClass.NET (parent)
      uses: actions/checkout@v4
      with:
        repository: ReClassNET/ReClass.NET
        path: ReClass.NET

    - name: Checkout MCP Plugin
      uses: actions/checkout@v4
      with:
        path: ReClass.NET/ReClass.NET.McpPlugin

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore ReClass.NET/ReClass.NET.sln

    - name: Build x86
      run: msbuild ReClass.NET/ReClass.NET.McpPlugin/ReClass.NET.McpPlugin.csproj /p:Configuration=Release /p:Platform=x86 /p:SolutionDir=ReClass.NET/

    - name: Build x64
      run: msbuild ReClass.NET/ReClass.NET.McpPlugin/ReClass.NET.McpPlugin.csproj /p:Configuration=Release /p:Platform=x64 /p:SolutionDir=ReClass.NET/

    - name: Prepare artifacts
      run: |
        mkdir -p artifacts/x86
        mkdir -p artifacts/x64
        cp ReClass.NET/bin/Release/x86/Plugins/McpPlugin.dll artifacts/x86/
        cp ReClass.NET/bin/Release/x64/Plugins/McpPlugin.dll artifacts/x64/
      shell: bash

    - name: Upload x86 artifact
      uses: actions/upload-artifact@v4
      with:
        name: McpPlugin-x86
        path: artifacts/x86/McpPlugin.dll

    - name: Upload x64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: McpPlugin-x64
        path: artifacts/x64/McpPlugin.dll

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download x86 artifact
      uses: actions/download-artifact@v4
      with:
        name: McpPlugin-x86
        path: x86

    - name: Download x64 artifact
      uses: actions/download-artifact@v4
      with:
        name: McpPlugin-x64
        path: x64

    - name: Create zip archives
      run: |
        cd x86 && zip ../McpPlugin-x86.zip McpPlugin.dll && cd ..
        cd x64 && zip ../McpPlugin-x64.zip McpPlugin.dll && cd ..

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          McpPlugin-x86.zip
          McpPlugin-x64.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
